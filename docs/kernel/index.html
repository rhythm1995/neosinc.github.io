<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-kernel/kernel">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.22">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Modern MicroKernel Operation System RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Modern MicroKernel Operation System Atom Feed"><title data-rh="true">Kernel | Modern MicroKernel Operation System</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zionsys.github.io/docs/kernel/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kernel | Modern MicroKernel Operation System"><meta data-rh="true" name="description" content="Modern Micro Kernel Design And Implementation"><meta data-rh="true" property="og:description" content="Modern Micro Kernel Design And Implementation"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zionsys.github.io/docs/kernel/"><link data-rh="true" rel="alternate" href="https://zionsys.github.io/docs/kernel/" hreflang="en"><link data-rh="true" rel="alternate" href="https://zionsys.github.io/docs/kernel/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.0a407a3b.css">
<link rel="preload" href="/assets/js/runtime~main.5db1e6f6.js" as="script">
<link rel="preload" href="/assets/js/main.9d3a29af.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ZionSystem</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Projects</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tee">ZionTEE</a></li><li><a class="dropdown__link" href="/visor">ZionVisor</a></li><li><a class="dropdown__link" href="/kernel">SynestiaOS NT</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/getting_start">Documentation</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/getting_start">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/kernel/">Next</a></li><li><a class="dropdown__link" href="/docs/getting_start">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/kernel/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><hr style="margin: 0.3rem 0;"></li><li><a href="https://github.com/ZionSys" target="_blank" rel="noopener noreferrer" class="dropdown__link">Help Us Translate<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://github.com/ZionSys" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/getting_start">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/bootloader">Bootloader</a><button aria-label="Toggle the collapsible sidebar category &#x27;Bootloader&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/hypervisor">Hypervisor</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hypervisor&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/kernel">Kernel</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kernel&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/kernel/">Kernel</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/platform">Platform</a><button aria-label="Toggle the collapsible sidebar category &#x27;Platform&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/tee">Tee</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tee&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/kernel"><span itemprop="name">Kernel</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kernel</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Kernel</h1><p>Modern Micro Kernel Design And Implementation</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aarch64-privilege-model">AArch64 Privilege Model<a class="hash-link" href="#aarch64-privilege-model" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="el1">EL1<a class="hash-link" href="#el1" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="el2">EL2<a class="hash-link" href="#el2" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="el3">EL3<a class="hash-link" href="#el3" title="Direct link to heading">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aarch64-exception-model">AArch64 Exception Model<a class="hash-link" href="#aarch64-exception-model" title="Direct link to heading">​</a></h2><p>异常模型和异常向量表</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aarch64-mmu-and-virtualmemory">AArch64 MMU and VirtualMemory<a class="hash-link" href="#aarch64-mmu-and-virtualmemory" title="Direct link to heading">​</a></h2><p>aarch64 虚拟内存</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mairtcr-config">MAIR/TCR Config<a class="hash-link" href="#mairtcr-config" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="blocktable-entry-foramt">Block/Table Entry Foramt<a class="hash-link" href="#blocktable-entry-foramt" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="identity-map">Identity Map<a class="hash-link" href="#identity-map" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="asid">ASID<a class="hash-link" href="#asid" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tlb-cache">TLB Cache<a class="hash-link" href="#tlb-cache" title="Direct link to heading">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="aarch64-switchcontext">AArch64 SwitchContext<a class="hash-link" href="#aarch64-switchcontext" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="xcontext">XContext<a class="hash-link" href="#xcontext" title="Direct link to heading">​</a></h3><p><code>XContext</code>(ExecuteContext), 执行上下文，
为了RPC上下文切换不影响调度，
于是将执行上下文和调度上下文(<code>SContext</code>)SchedulerContext分开。
这种执行上下文和调度上下文分开的设计，在实现迁移线程RPC的时候会带来诸多好处。</p><p><code>XContext</code>主要用来保存CPU现场，保存通用寄存器和系统寄存器，比如<code>sp</code>, <code>lr</code>, <code>spsr</code> 等，
在陷入异常的时候保存，从异常返回的时候恢复，
恢复哪个<code>XContext</code>就意味着从哪个<code>XContext</code>继续执行。</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct XContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArchCommonRegisters commonRegs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArchContextRegisters ctxRegs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ArchFpuRegisters fpuRegs;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} XContext;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中<code>commonRegs</code>为通用寄存器，<code>ctxRegs</code> 为系统寄存器，<code>fpuRegs</code>为FPU寄存器，
但是FPU上下文切换并不在CPU上下文切换时执行，
考虑到性能等因素，一般会选择Lazy的方式，暂时不详述，遇到了再说。</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct ArchCommonRegisters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x13;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x14;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x17;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x18;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x19;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x21;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x22;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x24;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x25;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x26;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x28;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x29; // FP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t x30; // LR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ArchCommonRegisters;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>系统寄存器</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct ArchContextRegisters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t spsr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t pc; // elr_el1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t sp; // sp_el0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t tpid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t tpidRo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ArchContextRegisters;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>浮点寄存器</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct ArchFpuRegisters {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d13;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d14;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d15;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d17;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d18;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d19;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d20;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d21;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d22;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d23;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d24;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d25;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d26;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d28;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d29;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d30;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t d31;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t fpsr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} ArchFpuRegisters;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当陷入异常，一般为中断, 系统调用, 以及异常；
比如定时的TimerTick中断，<code>SVC</code>指令触发的系统调用，未映射内存访问导致的缺页异常等。
以下以<code>EL0</code>中断陷入<code>EL1</code>为例：</p><div class="language-Assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    stp x0, x1, [sp, #16 * 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x2, x3, [sp, #16 * 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x4, x5, [sp, #16 * 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x6, x7, [sp, #16 * 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x8, x9, [sp, #16 * 4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x10, x11, [sp, #16 * 5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x12, x13, [sp, #16 * 6]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x14, x15, [sp, #16 * 7]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x16, x17, [sp, #16 * 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x18, x19, [sp, #16 * 9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x20, x21, [sp, #16 * 10]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x22, x23, [sp, #16 * 11]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x24, x25, [sp, #16 * 12]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x26, x27, [sp, #16 * 13]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x28, x29, [sp, #16 * 14]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    str x30, [sp, #16 * 15]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x9, spsr_el1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    str x9, [sp, #31 * 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x9, elr_el1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x10, sp_el0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x9, x10, [sp, #16 * 16]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x9, tpidr_el0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x9, tpidrro_el0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stp x9, x10, [sp, #16 * 17]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov x0, sp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mrs x2, mpidr_el1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    and x2, x2, #0xFF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov x3, #0x8000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mul x4, x2, x3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldr x2, =__kernel_stack_base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sub x2, x2, x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov sp, x2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b irq_entry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>stp</code>存储的顺序和<code>XContext</code>结构是一摸一样的，主要分为三步，
第一步：保存通用寄存器，即<code>ArchCommonRegisters commonRegs</code>,直接将<code>x0-x30</code>通过<code>stp</code>指令保存。
第二步：保存特殊寄存器，即<code>ArchContextRegisters ctxRegs</code>,
需要将保存的寄存器内容通过mrs从系统寄存器中读出，然后保存，顺序和<code>ArchContextRegisters</code>结构一致。
第三步：切换<code>sp</code>，将<code>sp</code>切换为内核<code>sp</code>, 如果不切换会导致之后的函数调用过程中会踩坏<code>XContext</code>地址之前的数据，
鬼知道踩坏的是啥，或许鬼也不知道踩坏的是啥，
具体来说该栈是为了在内核态可以做正常的函数调用，
所以一般就是在内核boot阶段设置的栈，有些人喜欢通过汇编保留一块地址，
有些人喜欢在链接脚本里保留地址，都可以。建议将其保存在<code>CpuLocal</code>结构中，将<code>CpuLocal</code>地址保存在<code>TPIDR</code>寄存器，
使用时通过<code>TPIDR</code>寄存器获取。</p><p>看完上面这段，读者可能会有一个疑问，为什么要将上下文保存到<code>sp</code>寄存器里的地址上，
因为在内核第一次进入线程的时候会将该线程<code>XContext</code>地址存到sp中，
所以sp在此之前一直是上一个被恢复的<code>XContext</code>的地址。</p><p>可以看一下<code>XContext</code>的恢复过程：</p><div class="language-Assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.global arch_switch_context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">arch_switch_context:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov sp, x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x9, x10, [sp, #16 * 16]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msr elr_el1, x9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msr sp_el0, x10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x9, x10, [sp, #16 * 17]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msr tpidr_el0, x9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msr tpidrro_el0, x10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldr x9, [sp, #8 * 31]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msr spsr_el1, x9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x0, x1, [sp, #16 * 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x2, x3, [sp, #16 * 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x4, x5, [sp, #16 * 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x6, x7, [sp, #16 * 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x8, x9, [sp, #16 * 4]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x10, x11, [sp, #16 * 5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x12, x13, [sp, #16 * 6]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x14, x15, [sp, #16 * 7]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x16, x17, [sp, #16 * 8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x18, x19, [sp, #16 * 9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x20, x21, [sp, #16 * 10]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x22, x23, [sp, #16 * 11]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x24, x25, [sp, #16 * 12]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x26, x27, [sp, #16 * 13]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldp x28, x29, [sp, #16 * 14]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ldr x30, [sp, #16 * 15]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eret</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中<code>x0</code>，即<code>arch_switch_context</code>函数的第一个参数为要被恢复到CPU上的<code>XContext</code>的地址。
这也解释了为何在保存上下文的时候可以直接保存到<code>sp</code>里的地址上。
以上恢复的过程和上下文保存过程类似，只是顺序相反，
因为特殊寄存器的恢复会导致通用寄存器变脏，
所以先恢复特殊寄存器，然后恢复通用寄存器，
最后通过<code>eret</code>指令返回，<code>eret</code>指令会返回到对应的低特权级，
并将<code>PC</code>设置为<code>elr_el1</code>寄存器中的值, 即<code>ArchContextRegisters</code>中的<code>pc</code>。</p><p>当然，上下文切换的过程中还有地址空间的切换，即<code>ttbr</code>寄存器的变更，
这部分在虚拟内存的章节详述。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="drivers">Drivers<a class="hash-link" href="#drivers" title="Direct link to heading">​</a></h2><p>为了支撑起内核的一些基本机制，所以一些基本的设备驱动是必要的。
比如timer，用来产生周期性的中断，来支撑调度机制。
又比如<code>GIC</code>通用中断处理器, 来完成一些中断的配置，路由。
还有串口驱动，来实现基本的输出打印，当然还可以有<code>RTC</code>提供时间，
<code>PMU</code> 用来做一些性能测量，trace的操作。这部分驱动都将写在内核代码中，
和内核一起编译。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generic-timer">Generic Timer<a class="hash-link" href="#generic-timer" title="Direct link to heading">​</a></h3><p><code>generic timer</code>作为一个核心驱动将会被放在内核中，为内核的<code>Timer</code>机制提供基础的支撑，
譬如产生周期性始终中断，又或者做定时操作，<code>timeout</code>， <code>sleep</code>等。</p><p><code>generic timer</code>相对简单，基本可以按照手册闭眼coding,
在此简单介绍一下其基本操作。</p><p><code>generic timer</code> 有一个全局的以固定频率增加的<code>System Counter</code>和每一个PE上的<code>timer</code>组成，
,PE上<code>timer</code>连着中断控制器，且其中的比较器会跟<code>system counter</code>的值进行对比，从而让其产生中断。</p><p><code>CNTPCT_EL0</code>寄存器中储存了当前的<code>system count</code>,
<code>CNTFRQ_EL0</code>寄存器保存了时钟频率，
也就是说<code>CNTPCT_EL0</code> / <code>CNTFRQ_EL0</code> 为系统启动到现在的秒数。</p><p>每一个<code>timer</code>都有一个控制寄存器，
一个比较寄存器和一个值寄存器，不确定叫值寄存器合不合理，
姑且就这么叫吧。</p><p>我们以<code>EL1 Physical Timer</code>为例：
<code>CNTP_CTL_EL1</code> 为控制寄存器，通过它我们可以打开或关闭中断，<code>0</code>位开关<code>timer</code>, <code>1</code>位mask中断。
<code>CNTP_CVAL_EL1</code> 为比较寄存器，系统会用它中的值和<code>system count</code>进行比较，如果一样时候会触发中断。
因此我们可以用它做到<code>timeout</code>的效果，比如在当前时间之后的两秒触发一个中断,
我们就可以在<code>CNTP_CVAL_EL1</code>中设置<code>CNTP_CTL_EL1 + CNTFRQ_EL0 * 2</code>,
便会在两秒之后触发中断。
<code>CNTP_TVAL_EL1</code> 值寄存器，这个更加直接，写多少就意味着在多久之后触发中断，
同样，比如在两秒之后触发中断，我们可以直接在<code>CNTP_TVAL_EL1</code>中写<code>CNTFRQ_EL0 * 2</code>，直接明了。</p><p>但是一般内核不会直接操作<code>generic timer</code>的寄存器，我们通过在<code>generic timer</code>驱动里向内核注册操作<code>generic timer</code>的钩子函数，
从而通过依赖导致，反向注册的方式让驱动和内核解耦，我们所有的驱动都会这样设计。</p><p>有了这个<code>generic timer</code>提供的基础机制之后，我们可以在内核抽象一个时间子系统，将用户态通过系统调用创建的所有timer管理起来，
然后设置到<code>generic timer</code>上，一般的时间子系统都会选择红黑树来管理，我们也是。其实在linux上还有时间轮来管理低精度时钟，
用红黑树来管理高精度时钟，我觉得没啥必要，所以只用红黑树,红黑树在内核中很多地方使用，比如内存管理等，关于红黑树的详细内容请阅附录章节，不在此展开。</p><p>在<code>generic timer</code>触发中断之后在中断处理程序里面从红黑树上拿到最左子节点，即离现在最近的的时间，
将其设置到<code>generic timer</code>上，然后去做当前触发的timer的事件处理。
这样周而复始：触发-&gt;从红黑树拿最左子节点-&gt;拿该节点时间设置<code>generic timer</code>。</p><p>关于时间子系统的其他部分和详细代码实现会在之后的时间子系统章节和Capability子系统详述，之后会慢慢填补这块蓝图。</p><p>基本的操作就这些，至于<code>timer</code>虚拟化的内容在<code>hypervisor</code>中详述。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gicv3">GICv3<a class="hash-link" href="#gicv3" title="Direct link to heading">​</a></h3><p>在前面的<code>generic timer</code> 中我们提到timer到期会回触发中断，
但是这个中断的触发和处理不是简单的打开<code>generic timer</code>控制寄存器<code>CNTP_CTL_EL1</code>中的中断位就行，除此之外我们还需要初始化和配置中断控制器<code>GIC</code>, 只有正确的配置了它，并打开了对应的中断号，我们才可以收到中断，中断才会被路由到Core, 我们的内核才会陷入到前面章节中所描述的异常向量表中irq中，才可以跳转到我们自定义的中断处理函数中。</p><p>我们在此简单的描述一下ARM的中断控制器<code>GIC</code>, 它发展至今似乎经历了三个版本<code>GICv2</code>,
<code>GICv3</code>,<code>GICv4</code>, 每一个版本都是在旧的版本之上增加了一些新的特性。</p><p>GIC主要由CPUInterface, Distributor, ReDistributor 组成，其中吧啦吧啦吧...<code>TODO</code></p><p>GIC的操作和<code>generic timer</code>的操作稍微有点差异，<code>GIC</code>的寄存器是内存映射的，它并没有系统寄存器可以直接读写，所谓内存映射的就是说它的一些寄存器和部分内存连在了一起，我们直接操作对应内存的时候就是在操作它的寄存器，说连在一起可能不是很准确，如果读者写过verilog之类的会很容易理解，反正就是我们对一段物理内存直接读写即可对GIC进行配置，不同的硬件平台GIC地址会有差异，这部分不同硬件平台的配置会保存在dtb中，我们直接读取即可，关于dts/dtb的详细内容，在附录章节。除此之外我们也可以通过读取系统寄存器<code>CBAR_EL1</code>即<code>S3_1_C15_C3_0</code>来拿到内存映射的GIC CPU Interface 的地址，看到这个古怪的寄存器，读者似乎会很诧异，不要怀疑，这只是<code>aarch64</code>对于<code>CP15</code>协处理器中寄存器的一种类似别名的东西。<code>CBAR_EL1</code>中<code>18～39</code>位便是地址。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pl011-uart">PL011 uart<a class="hash-link" href="#pl011-uart" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pl031-rtc">PL031 rtc<a class="hash-link" href="#pl031-rtc" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pmu">PMU<a class="hash-link" href="#pmu" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pmu寄存器">PMU寄存器<a class="hash-link" href="#pmu寄存器" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cpucontext">CPUContext<a class="hash-link" href="#cpucontext" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="perfcontext">PerfContext<a class="hash-link" href="#perfcontext" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="dsu_pmu">DSU_PMU<a class="hash-link" href="#dsu_pmu" title="Direct link to heading">​</a></h4><h2 class="anchor anchorWithStickyNavbar_LWe7" id="syscall">SysCall<a class="hash-link" href="#syscall" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="capability">Capability<a class="hash-link" href="#capability" title="Direct link to heading">​</a></h2><p>一般用户态应用程序对于内核功能的使用可以简单的描述为一句话 &quot;我需要什么东西做什么&quot;，
什么东西在这里可以指<code>Timer</code>, 可以指<code>Scheduler</code>, 也可以指<code>IPC</code>，等等等。。。
换句话说这句话说明了用户态对于内核的操作需要提供一个内核对象，和一个操作。
再描述的程序一点大概是这个样子，需要一个内核对象的引用，和一个操作方法，以及操作所需要的参数,
用代码描述如下：</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OS_{Type}{Method}(ref, args...);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>比如，对一个Timer设置时间：</p><div class="language-C codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-C codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OS_TimerSetTime(xxxx, xxxx);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样，就可以把所有用户态对于内核的操作统一成这样的形式。
这样精确到内核对象的好处是，我们可以将权限细粒度到每一个内核对象上，
甚至每一个内核对象的方法上，比如上面代码中的<code>SetTime</code>。
为此，我们需要一个权限系统在上面的内核接口被调用下去的时候做权限的校验，
以及在内核对象被创建的时候做权限的授予。
于是我们为每个进程设计了<code>CNode</code>来管理，保存，权限信息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ipc">IPC<a class="hash-link" href="#ipc" title="Direct link to heading">​</a></h2><p>迁移线程IPC，得益于将执行上下文<code>XContext</code>和调度上下文<code>SContext</code>分开的设计，
IPC的实现简单了很多，传统的进程间通信在Client端发出请求之后，
需要等到Server线程在被调度到CPU上之后才能做出响应，
也意味着在下一次Client被调度上CPU之后Client才能收到响应。
这个过程是不确定的，有可能很快，也有可能很慢，一般这个叫做调度开销，
因此我们考虑在Client发送请求到Server的时候，
可以将Server线程设置为下一个被调度上CPU的线程，
Server在响应的时候将Client线程设置为下一个被调度上CPU的线程，
这样就可以做到相对快速的IPC响应。但是这似乎有个问题，
IPC操作影响了调度器的行为，如果Client一直请求，
就会使调度器一直在Client和Server线程之间切换，
其他线程将得不到调度上CPU的机会,这看起来是个严重的问题。</p><p>但是将执行上下文<code>XContext</code>和调度上下文<code>SContext</code>分开的设计，
可以使得在IPC的时候只对<code>XContext</code>和地址空间在IPC系统调用中进行切换，
<code>SContext</code>由调度器和其策略控制切换，在保证了IPC速度的同时不会影响调度，
看起来非常有趣。</p><p>也非常简单，在这儿简略说明一下核心，根据<code>AAPCS</code>，函数调用的时候参数会放在<code>x0-x7</code>寄存器中，返回地址即下一条指令放到<code>lr</code>寄存器即<code>x30</code>中，
然后跳转到目标函数中，目标函数在执行完成之后会将结果保存在<code>x1</code>寄存器中，然后跳转到<code>lr</code>寄存器中的地址上。</p><p>我们只需要简单的修改一下这个过程就可以做到进程间通信，为此我们需要被调接口所在进程的地址空间即页表地址，以及目标接口函数的地址。
有了这两个信息，我们只需要在IPC中断返回的时候将地址空间切换到接口进程的地址空间。
构造一个<code>XContext</code>, 把IPC的参数放到该<code>XContext</code>的通用寄存结构中，
将目标接口函数的地址放到该<code>XContext</code>的<code>pc</code>中。</p><p>然后从系统调用返回的时候将CPU恢复成该<code>XContext</code>就可以切过去了，
这时候聪明的你肯定发现了，那我接口函数里执行完了怎么返回呢？
问得好，我们可以不可以这样，在构造那个<code>XContext</code>的时候，同时修改它的<code>lr</code>寄存器即<code>x30</code>寄存器，修改成什么呢？
修改成当前<code>elr_el1</code>? 看似来似乎没问题，但是忽略了一个关键点，<code>elr_el1</code>中的地址在当前进程的地址空间，而不是在目标接口函数所在的地址空间，
这样的话显然目标接口函数在执行完之后无法返回，显然会触发<code>DataAbort</code>，无法返回回来。</p><p>于是，这就有了一个精妙的设计，我们需要一个目标接口函数所能返回到的函数作为跳板，在它里面发起一个REPLY IPC系统调用，切换地址空间，并返回到当前的<code>XContext</code>,
而那个函数的地址会在构造<code>XContext</code>的时候放到<code>lr</code>(<code>x30</code>)中，对，我们为了跳转到接口函数而构造的<code>XContext</code>的<code>lr</code>(<code>x30</code>)中是这个跳板函数的地址，而不是<code>elr_el1</code>, 这很关键。</p><p>当然IPC参数传递这里只是简单描述了基本类型参数的传递，除了基本类型之外我们还会有结构体，指针等的参数，这种跨地址空间的参数会稍微麻烦一点。</p><p>好了，详细内容看实现吧。</p><p>IPC，主要的操作点为Client线程发起IPC请求，
Server线程发起IPC响应，这两个操作可以设计为两个系统调用：</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipc-请求">IPC 请求<a class="hash-link" href="#ipc-请求" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ipc-响应">IPC 响应<a class="hash-link" href="#ipc-响应" title="Direct link to heading">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scheduler">Scheduler<a class="hash-link" href="#scheduler" title="Direct link to heading">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="genesis">Genesis<a class="hash-link" href="#genesis" title="Direct link to heading">​</a></h2><p>由内核拉起的第一个用户态线程，也是微内核的核心，
绝大部分在宏内核中本该属于内核态的功能，都将会在该进程中，
并提供RPC接口， 为其他进程提供服务。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dsl-generator">DSL-Generator<a class="hash-link" href="#dsl-generator" title="Direct link to heading">​</a></h2><p>一个用Rust写的将微内核IPC接口描述文件转换成server端和client端代码的工具。
通过DSL的方式编写接口会极大的方便开发，并屏蔽IPC调用的细节操作，
对开发者非常友好。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="devhost">DevHost<a class="hash-link" href="#devhost" title="Direct link to heading">​</a></h2><p>用户态驱动host进程，又想兼容linux的驱动生态，
又不想搞一个进程跑魔改版linux, 头秃...
重新写原生驱动是件痛苦的事情。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="附">附<a class="hash-link" href="#附" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="红黑树">红黑树<a class="hash-link" href="#红黑树" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dtsdtb">DTS/DTB<a class="hash-link" href="#dtsdtb" title="Direct link to heading">​</a></h3></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ZionSys/webiste/tree/master/docs/kernel/kernel.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/kernel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kernel</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/platform"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Platform</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aarch64-privilege-model" class="table-of-contents__link toc-highlight">AArch64 Privilege Model</a><ul><li><a href="#el1" class="table-of-contents__link toc-highlight">EL1</a></li><li><a href="#el2" class="table-of-contents__link toc-highlight">EL2</a></li><li><a href="#el3" class="table-of-contents__link toc-highlight">EL3</a></li></ul></li><li><a href="#aarch64-exception-model" class="table-of-contents__link toc-highlight">AArch64 Exception Model</a></li><li><a href="#aarch64-mmu-and-virtualmemory" class="table-of-contents__link toc-highlight">AArch64 MMU and VirtualMemory</a><ul><li><a href="#mairtcr-config" class="table-of-contents__link toc-highlight">MAIR/TCR Config</a></li><li><a href="#blocktable-entry-foramt" class="table-of-contents__link toc-highlight">Block/Table Entry Foramt</a></li><li><a href="#identity-map" class="table-of-contents__link toc-highlight">Identity Map</a></li><li><a href="#asid" class="table-of-contents__link toc-highlight">ASID</a></li><li><a href="#tlb-cache" class="table-of-contents__link toc-highlight">TLB Cache</a></li></ul></li><li><a href="#aarch64-switchcontext" class="table-of-contents__link toc-highlight">AArch64 SwitchContext</a><ul><li><a href="#xcontext" class="table-of-contents__link toc-highlight">XContext</a></li></ul></li><li><a href="#drivers" class="table-of-contents__link toc-highlight">Drivers</a><ul><li><a href="#generic-timer" class="table-of-contents__link toc-highlight">Generic Timer</a></li><li><a href="#gicv3" class="table-of-contents__link toc-highlight">GICv3</a></li><li><a href="#pl011-uart" class="table-of-contents__link toc-highlight">PL011 uart</a></li><li><a href="#pl031-rtc" class="table-of-contents__link toc-highlight">PL031 rtc</a></li><li><a href="#pmu" class="table-of-contents__link toc-highlight">PMU</a></li></ul></li><li><a href="#syscall" class="table-of-contents__link toc-highlight">SysCall</a></li><li><a href="#capability" class="table-of-contents__link toc-highlight">Capability</a></li><li><a href="#ipc" class="table-of-contents__link toc-highlight">IPC</a><ul><li><a href="#ipc-请求" class="table-of-contents__link toc-highlight">IPC 请求</a></li><li><a href="#ipc-响应" class="table-of-contents__link toc-highlight">IPC 响应</a></li></ul></li><li><a href="#scheduler" class="table-of-contents__link toc-highlight">Scheduler</a></li><li><a href="#genesis" class="table-of-contents__link toc-highlight">Genesis</a></li><li><a href="#dsl-generator" class="table-of-contents__link toc-highlight">DSL-Generator</a></li><li><a href="#devhost" class="table-of-contents__link toc-highlight">DevHost</a></li><li><a href="#附" class="table-of-contents__link toc-highlight">附</a><ul><li><a href="#红黑树" class="table-of-contents__link toc-highlight">红黑树</a></li><li><a href="#dtsdtb" class="table-of-contents__link toc-highlight">DTS/DTB</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/getting_start">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/ZionSys" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/ZionSys" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ZionSys" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ZionSys" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://zionsys.github.io" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/logo.png" alt="Zion Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="60px"><img src="/img/logo.png" alt="Zion Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="60px"></a></div><div class="footer__copyright">Copyright © 2022 ZionSystem Group.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5db1e6f6.js"></script>
<script src="/assets/js/main.9d3a29af.js"></script>
</body>
</html>